{% extends 'base.html' %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="text-warning-neon fw-bold"><i class="bi bi-box-seam me-2"></i>SISTEMA DE BODEGA PRO</h2>
        <span class="badge bg-dark border border-warning text-warning px-3 py-2">Operador: {{ user.username }}</span>
    </div>

    <div class="card bg-dark border-warning mb-4 shadow-lg" style="border-width: 2px;">
        <div class="card-body">
            <div class="row align-items-center">
                <div class="col-md-7">
                    <form method="GET" class="position-relative">
                        <i class="bi bi-upc-scan text-warning position-absolute" style="left: 15px; top: 12px; z-index: 10; font-size: 1.2rem;"></i>
                        <input type="text" name="q" id="scannerInput" 
                               class="form-control form-control-lg bg-black text-warning border-warning ps-5 fw-bold" 
                               placeholder="ESCANE√â AQU√ç O ESCRIBA T√çTULO..." 
                               value="{{ query|default:'' }}" autofocus>
                        {% if query %}
                            <a href="?" class="position-absolute text-danger" style="right: 15px; top: 12px; z-index: 10;"><i class="bi bi-x-circle-fill"></i></a>
                        {% endif %}
                    </form>
                    <small class="text-muted mt-1 d-block"><i class="bi bi-lightning-charge"></i> Modo Esc√°ner Activo: El cursor siempre volver√° aqu√≠.</small>
                </div>

                <div class="col-md-5 text-md-end mt-3 mt-md-0">
                    <button type="button" class="btn btn-warning fw-bold px-4 py-2 shadow" data-bs-toggle="modal" data-bs-target="#modalPedidos">
                        <i class="bi bi-file-earmark-spreadsheet-fill me-2"></i>LISTA PARA PEDIDOS
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="card bg-dark border-secondary mb-4 shadow">
        <div class="card-body d-flex flex-wrap align-items-center gap-2">
            <span class="text-white-50 me-2"><i class="bi bi-filter-right"></i> FILTRAR POR ESTADO:</span>
            
            <a href="?estado=critico" class="btn btn-outline-danger btn-sm {% if filtro_actual == 'critico' %}active{% endif %}">
                <i class="bi bi-exclamation-octagon me-1"></i> CR√çTICO (0-2)
            </a>
            
            <a href="?estado=bajo" class="btn btn-outline-warning btn-sm {% if filtro_actual == 'bajo' %}active{% endif %}">
                <i class="bi bi-exclamation-triangle me-1"></i> BAJO (3-5)
            </a>
            
            <a href="?" class="btn btn-outline-info btn-sm {% if not filtro_actual %}active{% endif %}">
                <i class="bi bi-list-ul me-1"></i> VER TODO
            </a>
        </div>
    </div>

    {% if alertas %}
    <div class="alert alert-danger bg-dark border-danger text-danger border-2 shadow-lg animate__animated animate__pulse animate__infinite">
        <i class="bi bi-megaphone-fill me-2"></i> 
        <strong>ATENCI√ìN JOSU√â:</strong> Tienes {{ alertas.count }} libros con stock cr√≠tico. ¬°Necesitan reabastecimiento!
    </div>
    {% endif %}

    <div class="table-responsive rounded-3 shadow">
        <table class="table table-dark table-hover align-middle border-secondary mb-0">
            <thead class="table-warning text-dark fw-bold">
                <tr>
                    <th>LIBRO / INFORMACI√ìN</th>
                    <th style="width: 200px;">UBICACI√ìN (ESTANTE)</th>
                    <th style="width: 150px;">STOCK REAL</th>
                    <th>ACCI√ìN</th>
                </tr>
            </thead>
            <tbody>
                {% for libro in libros %}
                <tr>
                    <td>
                        <div class="fw-bold fs-5 text-white">{{ libro.titulo }}</div>
                        <span class="badge bg-secondary opacity-75">{{ libro.autor }}</span>
                    </td>
                    <form action="{% url 'gestion:actualizar_stock_bodega' libro.id %}" method="POST">
                        {% csrf_token %}
                        <td>
                            <input type="text" name="estante" class="form-control form-control-sm bg-dark text-info border-secondary fw-bold" 
                                   value="{{ libro.estante|default:'Sin asignar' }}">
                        </td>
                        <td>
                            <input type="number" name="stock" class="form-control form-control-sm border-2 fw-bold text-center
                                   {% if libro.copias_disponibles <= 2 %}bg-danger text-white border-danger{% else %}bg-dark text-success border-success{% endif %}" 
                                   value="{{ libro.copias_disponibles }}">
                        </td>
                        <td>
                            <button type="submit" class="btn btn-warning btn-sm fw-bold w-100 shadow-sm">
                                <i class="bi bi-save2"></i> GUARDAR
                            </button>
                        </td>
                    </form>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="4" class="text-center py-5 text-muted fs-4">
                        <i class="bi bi-search mb-2 d-block fs-1"></i> No se encontraron libros.
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<div class="modal fade" id="modalPedidos" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content bg-dark text-white border-warning border-2">
            <div class="modal-header border-warning">
                <h5 class="modal-title text-warning fw-bold"><i class="bi bi-cart-plus me-2"></i>PEDIDO DE REPOSICI√ìN</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <textarea class="form-control bg-black text-success border-0 font-monospace" rows="12" id="textoPedido" readonly>
üìã LISTA DE PEDIDOS - BODEGA JOSU√â
üìÖ Fecha: {% now "d/m/Y" %}
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
{% for alerta in alertas %}
üîπ {{ alerta.titulo|upper }}
   Stock: {{ alerta.copias_disponibles }} unidades
   Ubicaci√≥n: {{ alerta.estante|default:"No asignado" }}
{% empty %}
‚úÖ TODO EL STOCK EST√Å COMPLETO.
{% endfor %}
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
Responsable: {{ user.username }}</textarea>
            </div>
            <div class="modal-footer border-warning">
                <button type="button" class="btn btn-warning w-100 fw-bold" onclick="copiarAlPortapapeles()">
                    <i class="bi bi-clipboard-check me-2"></i>COPIAR LISTA PARA WHATSAPP
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    // Foco autom√°tico infinito en el esc√°ner
    const scanner = document.getElementById('scannerInput');
    
    // Al cargar la p√°gina
    window.onload = () => scanner.focus();
    
    // Si hace clic en cualquier lado, el cursor vuelve al esc√°ner despu√©s de 1 segundo
    scanner.addEventListener('blur', () => {
        setTimeout(() => scanner.focus(), 1000);
    });

    // Funci√≥n para copiar la lista
    function copiarAlPortapapeles() {
        const text = document.getElementById('textoPedido');
        text.select();
        document.execCommand('copy');
        alert("¬°Lista copiada! Ya puedes pegarla en WhatsApp o enviarla al jefe.");
    }
</script>

<style>
    .text-warning-neon { color: #ffc107; text-shadow: 0 0 10px rgba(255, 193, 7, 0.5); }
    .bg-black { background-color: #000 !important; }
    .form-control:focus {
        background-color: #1a1a1a !important;
        color: #fff !important;
        border-color: #ffc107 !important;
        box-shadow: 0 0 15px rgba(255, 193, 7, 0.4);
    }
    .active {
        background-color: rgba(255, 193, 7, 0.2) !important;
        border-color: #ffc107 !important;
        color: #ffc107 !important;
    }
</style>
{% endblock %}