{% extends "base.html" %}

{% block title %}Control de Préstamos{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h3 class="text-danger"><i class="bi bi-arrow-down-up me-2"></i> Control de Préstamos y Devoluciones</h3>
    <a href="{% url 'gestion:nuevo_prestamo' %}" class="btn btn-danger btn-sm">
        <i class="bi bi-plus-circle-fill me-1"></i> Nuevo Préstamo
    </a>
</div>
<p class="lead text-secondary">Consulta los préstamos activos y el historial de transacciones.</p>

<div class="row mb-4">
    <div class="col-md-8">
        <form method="GET" action="{% url 'gestion:prestamos' %}" class="input-group">
            <input 
                type="search" 
                name="q" 
                class="form-control form-control-dark" 
                placeholder="Buscar por Título de Libro, Lector o Identificación..." 
                value="{{ query|default:'' }}"
            >
            <button class="btn btn-outline-danger" type="submit">
                <i class="bi bi-search"></i> Buscar
            </button>
            {% if query %}
                <a href="{% url 'gestion:prestamos' %}" class="btn btn-outline-secondary">
                    <i class="bi bi-x-lg"></i> Limpiar
                </a>
            {% endif %}
        </form>
    </div>
</div>
{% if query %}
<div class="alert alert-warning border border-danger text-dark fw-bold">
    <i class="bi bi-search me-2"></i> Mostrando resultados para: "{{ query }}"
</div>
{% endif %}


<ul class="nav nav-tabs" id="prestamosTab" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="activos-tab" data-bs-toggle="tab" data-bs-target="#activos" type="button" role="tab" aria-controls="activos" aria-selected="true">
            <i class="bi bi-clock-history me-1"></i> Préstamos Activos ({{ prestamos_activos|length }})
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="historico-tab" data-bs-toggle="tab" data-bs-target="#historico" type="button" role="tab" aria-controls="historico" aria-selected="false">
            <i class="bi bi-check2-square me-1"></i> Histórico de Devoluciones ({{ prestamos_historicos|length }})
        </button>
    </li>
</ul>

<div class="tab-content pt-3" id="prestamosTabContent">

    <div class="tab-pane fade show active" id="activos" role="tabpanel" aria-labelledby="activos-tab">
        <div class="table-responsive">
            {% if prestamos_activos %}
            <table class="table table-dark table-hover mb-0">
                <thead>
                    <tr class="table-danger">
                        <th>Libro Prestado</th>
                        <th>Lector (ID)</th>
                        <th>Fecha Préstamo</th>
                        <th>Fecha Esperada</th>
                        <th>Estado</th>
                        <th>Acción</th>
                    </tr>
                </thead>
                <tbody>
                    {% for prestamo in prestamos_activos %}
                    <tr>
                        <td>{{ prestamo.libro.titulo }} <small class="text-muted">({{ prestamo.libro.autor.apellido }})</small></td>
                        <td>{{ prestamo.lector.nombre }} <small class="text-muted">({{ prestamo.lector.identificacion }})</small></td>
                        <td>{{ prestamo.fecha_prestamo|date:"d M Y" }}</td>
                        <td class="{% if prestamo.fecha_devolucion_esperada < now %}text-warning fw-bold{% endif %}">
                            {{ prestamo.fecha_devolucion_esperada|date:"d M Y" }}
                            {% if prestamo.fecha_devolucion_esperada < now %}
                                <span class="badge bg-warning text-dark ms-1">¡Vencido!</span>
                            {% endif %}
                        </td>
                        <td><span class="badge bg-danger">Activo</span></td>
                        <td>
                            <a href="{% url 'gestion:devolver_prestamo' prestamo.pk %}" class="btn btn-success btn-sm">
                                <i class="bi bi-arrow-return-left"></i> Registrar Devolución
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
                <div class="alert alert-dark mt-4 border border-info text-info">
                    <i class="bi bi-info-circle-fill me-2"></i>
                    No hay préstamos activos registrados o no coinciden con la búsqueda.
                </div>
            {% endif %}
        </div>
    </div>

    <div class="tab-pane fade" id="historico" role="tabpanel" aria-labelledby="historico-tab">
        <div class="table-responsive">
            {% if prestamos_historicos %}
            <table class="table table-dark table-hover mb-0">
                <thead>
                    <tr class="table-secondary">
                        <th>Libro Prestado</th>
                        <th>Lector (ID)</th>
                        <th>Fecha Préstamo</th>
                        <th>Fecha Devolución</th>
                        <th>Estado</th>
                    </tr>
                </thead>
                <tbody>
                    {% for prestamo in prestamos_historicos %}
                    <tr>
                        <td>{{ prestamo.libro.titulo }}</td>
                        <td>{{ prestamo.lector.nombre }}</td>
                        <td>{{ prestamo.fecha_prestamo|date:"d M Y" }}</td>
                        <td>Registro Manual (N/A)</td> <td><span class="badge bg-success">Devuelto</span></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
                <div class="alert alert-dark mt-4 border border-info text-info">
                    <i class="bi bi-info-circle-fill me-2"></i>
                    No hay historial de devoluciones o no coincide con la búsqueda.
                </div>
            {% endif %}
        </div>
    </div>

</div>

{% endblock %}